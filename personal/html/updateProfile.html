<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="../assets/css/style2.css">
  <link rel="stylesheet" href="../assets/fonts/themify-icons2.css">
  <title>Trang cá nhân</title>
</head>

<body>
  <div class="main">
    <div id="content">
      <div class="personalRowRegiter row rounded-2">
        <div class="container row">
          <div class="profile rounded-2">
            <div class="menubar mt-3">
              <a href="../"><i class="ti-home"></i></a>
              <a href="/profile"><i class="ti-user"></i></a>
            </div>
            <div class="avtProfile mt-3">
              <div class="avtContainer">
                <div id="updateAvt" class="avatar">
                  <img id="linkAvatar" src="../assets/img/avatar-trang.jpg" alt="Avatar">
                </div>
               
              </div>
              <div class="editBtn">
                <button class="editBtn rounded-2" onclick="editProfileAvt()">Thay đổi Ảnh đại diện</button>
    <input type="file" id="avatarInput" style="display: none;" accept="image/*" onchange="handleAvatarChange()">
            </div>
              <div class="profileAll mt-3">
                <p class="userName"></p>
                <div class="information informationUpdate">
                  <label for="" class="phoneCt">
                    <i class="ti-email"></i>
                    <span id="updateEmail"></span>
                    <button id="saveEmail" class="editBtn saveEmail rounded-2" onclick="editProfilemail()"><i
                        class="ti-pencil-alt"></i></button>

                  </label>
                  <label for="" class="phoneCt">
                    <i class="ti-link"></i>
                    <span id="updateLink"><a class="face" href=""
                        target="_blank"></a> </span>
                    <button id="saveLink" class="editBtn saveLink rounded-2" onclick="editProfilelink()"><i class="ti-pencil-alt"></i></button>

                </label>
                  <label for="" class="phoneCt">
                    <i class="ti-mobile"></i>
                    <span id="updatePhone"> </span>
                    <button id="savePhone" class="editBtn savePhone rounded-2" onclick="editProfilePhone()"><i
                        class="ti-pencil-alt"></i></button>

                </label>
                </div>
                <div class="edit">
                  <button class="editProfile btn-primary btn" type="button" onclick="saveChanges()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</body>

<script>
  // update email
  function editProfilemail() {
    var emailSpan = document.getElementById("updateEmail");
    var emailnewInput = document.createElement("input");
    emailnewInput.setAttribute("type", "email");
    emailnewInput.setAttribute("value", emailSpan.innerText);
    emailSpan.parentNode.replaceChild(emailnewInput, emailSpan);

    var button = document.querySelector(".saveEmail");
    button.innerHTML = '<i class="ti-check"></i>';
    button.setAttribute("onclick", "saveProfile()");
  }

  function saveProfile() {
    var emailnewInput = document.querySelector("input[type='email']:nth-child(2)");
    var email = emailnewInput.value;
    var emailSpan = document.createElement("span");
    emailSpan.setAttribute("id", "updateEmail");
    emailSpan.innerText = email;
    emailnewInput.parentNode.replaceChild(emailSpan, emailnewInput);

    var button = document.getElementById("saveEmail");
    button.innerHTML = '<i class="ti-pencil-alt"></i>'
    button.setAttribute("onclick", "editProfilemail()");
  }

  // update phone
  function editProfilePhone() {
    var phoneSpan = document.getElementById("updatePhone");
    var phonenewInput = document.createElement("input");
    phonenewInput.setAttribute("type", "number");
    phonenewInput.setAttribute("value", phoneSpan.innerText);
    phoneSpan.parentNode.replaceChild(phonenewInput, phoneSpan);

    var button = document.querySelector(".savePhone");
    button.innerHTML = '<i class="ti-check"></i>';
    button.setAttribute("onclick", "saveProfilePhone()");
  }

  function saveProfilePhone() {
    var phonenewInput = document.querySelector("input[type='number']:nth-child(2)");
    var phone = phonenewInput.value;
    var phoneSpan = document.createElement("span");
    phoneSpan.setAttribute("id", "updatePhone");
    phoneSpan.innerText = phone;
    phonenewInput.parentNode.replaceChild(phoneSpan, phonenewInput);

    var button = document.getElementById("savePhone");
    button.innerHTML = '<i class="ti-pencil-alt"></i>'
    button.setAttribute("onclyick", "editProfilePhone()");
  }

  // Update link fackbook
  function editProfilelink() {
    var linkSpan = document.getElementById("updateLink");
    var link = linkSpan.innerText.trim();

    var linkInput = document.createElement("input");
    linkInput.setAttribute("type", "text");
    linkInput.setAttribute("value", link);
    
    linkSpan.parentNode.replaceChild(linkInput, linkSpan);

    var button = document.getElementById("saveLink");
    button.innerHTML = '<i class="ti-check"></i>';
    button.setAttribute("onclick", "saveProfilelink()");
}

function saveProfilelink() {
    var linkInput = document.querySelector("input[type='text']");
    var link = linkInput.value.trim();

    var linkSpan = document.createElement("span");
    linkSpan.setAttribute("id", "updateLink");
    linkSpan.innerHTML = '<a href="' + link + '" target="_blank">' + link + '</a>';

    linkInput.parentNode.replaceChild(linkSpan, linkInput);

    var button = document.getElementById("saveLink");
    button.innerHTML = '<i class="ti-pencil-alt"></i>';
    button.setAttribute("onclick", "editProfilelink()");
}

    // thay avt
    function editProfileAvt() {
      var avatarInput = document.getElementById('avatarInput');
      avatarInput.click(); // Kích hoạt sự kiện click trên thẻ input file để mở hộp thoại chọn tệp
  }

    function handleAvatarChange() {
      var avatarInput = document.getElementById('avatarInput');
      var avatar = document.getElementById('updateAvt').querySelector('img');

      var file = avatarInput.files[0];
      var reader = new FileReader();

      reader.onload = function(e) {
          avatar.src = e.target.result;
      }

      //console.log(file);
      reader.readAsDataURL(file);
      if (file) {
                const formData = new FormData();
                formData.append('avatar', file);

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to upload avatar');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data.message);
                })
                .catch(error => {
                    console.error(error.message);
                });
            } else {
                console.error('Please select an image file');
            }
  }

  function saveChanges() {
  // Lấy dữ liệu đã cập nhật từ form
  var email = document.getElementById("updateEmail").innerText;
  var facebookLink = document.querySelector("#updateLink a").getAttribute("href");
  var phone = document.getElementById("updatePhone").innerText;

  // Đóng gói dữ liệu vào một object
  var updatedData = {
    mail: email,
    facebook: facebookLink,
    phone: phone
  };

  console.log(updatedData);
  // Gửi yêu cầu POST đến server để cập nhật thông tin
  fetch('/update/profile', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(updatedData),
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    
    return response.json();
  })
  .then(data => {
    console.log('Success:', data);
    alert('Profile updated successfully!');
    window.location.href = '/profile';
  })
  .catch((error) => {
    console.error('Error:', error);
    alert('An error occurred while updating the profile.');
  });
}

</script>

</html>